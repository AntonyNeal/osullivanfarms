name: Manual Deployment Tools

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        type: choice
        options:
          - production
          - staging
      component:
        description: 'Component to deploy'
        required: true
        type: choice
        options:
          - frontend
          - api
          - both
      skip_tests:
        description: 'Skip quality checks'
        required: false
        type: boolean
        default: false

env:
  NODE_VERSION: '20'
  REGISTRY: osullivanfarmsacr.azurecr.io
  IMAGE_NAME: osullivanfarms-api

jobs:
  quality-checks:
    name: Quality Checks
    runs-on: ubuntu-latest
    if: ${{ !inputs.skip_tests }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run checks
        run: |
          npm run lint
          npm run type-check
          npm run build

  deploy-frontend:
    name: Deploy Frontend
    runs-on: ubuntu-latest
    needs: [quality-checks]
    if: |
      always() && 
      (needs.quality-checks.result == 'success' || needs.quality-checks.result == 'skipped') &&
      (inputs.component == 'frontend' || inputs.component == 'both')
    environment:
      name: ${{ inputs.environment }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install and build
        run: |
          npm ci
          npm run build
        env:
          VITE_API_BASE_URL: https://osullivanfarms-api.wonderfulsky-3834edbe.eastus2.azurecontainerapps.io/api

      - name: Deploy to Azure Static Web Apps
        uses: Azure/static-web-apps-deploy@v1
        with:
          azure_static_web_apps_api_token: ${{ inputs.environment == 'production' && secrets.AZURE_STATIC_WEB_APPS_API_TOKEN || secrets.AZURE_STATIC_WEB_APPS_API_TOKEN_STAGING }}
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          action: 'upload'
          app_location: '/'
          output_location: 'dist'
          skip_app_build: true

  deploy-api:
    name: Deploy API
    runs-on: ubuntu-latest
    needs: [quality-checks]
    if: |
      always() && 
      (needs.quality-checks.result == 'success' || needs.quality-checks.result == 'skipped') &&
      (inputs.component == 'api' || inputs.component == 'both') &&
      inputs.environment == 'production'
    environment:
      name: production
      url: https://osullivanfarms-api.wonderfulsky-3834edbe.eastus2.azurecontainerapps.io
    steps:
      - uses: actions/checkout@v4

      - name: Log in to Azure
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Build and push container
        uses: azure/docker-login@v1
        with:
          login-server: ${{ env.REGISTRY }}
          username: ${{ secrets.REGISTRY_USERNAME }}
          password: ${{ secrets.REGISTRY_PASSWORD }}

      - name: Build and push Docker image
        working-directory: ./api
        run: |
          docker build . -t ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:manual-${{ github.run_number }} -t ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
          docker push ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:manual-${{ github.run_number }}
          docker push ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest

      - name: Deploy to Container Apps
        uses: azure/container-apps-deploy-action@v1
        with:
          resourceGroup: osullivanfarms-rg
          containerAppName: osullivanfarms-api
          imageToDeploy: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:manual-${{ github.run_number }}
          environmentVariables: |
            NODE_ENV=production
            PORT=8080
            DB_HOST=${{ secrets.DB_HOST }}
            DB_PORT=${{ secrets.DB_PORT }}
            DB_NAME=${{ secrets.DB_NAME }}
            DB_USER=${{ secrets.DB_USER }}
            DB_PASSWORD=${{ secrets.DB_PASSWORD }}
            DB_SSL=require
            SENDGRID_API_KEY=${{ secrets.SENDGRID_API_KEY }}
            SENDGRID_FROM_EMAIL=${{ secrets.SENDGRID_FROM_EMAIL }}
            ALLOWED_ORIGINS=https://witty-coast-049457e0f.3.azurestaticapps.net,https://kind-smoke-078aaff0f.azurestaticapps.net
